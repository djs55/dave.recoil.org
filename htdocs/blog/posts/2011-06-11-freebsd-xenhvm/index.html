<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>2011-06-11-freebsd-xenhvm</title>

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css" type="text/css" />





</head>
<body>

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">

<a href="../../">Dave Scott</a>/ 

<a href="../">posts</a>/ 

</span>
<span class="title">
2011-06-11-freebsd-xenhvm

</span>
</span><!--.header-->

</div>


<div class="actions">
<ul>


<li><a href="../../recentchanges/">RecentChanges</a></li>





<li><a href="./#comments">Comments</a><br /></li>

</ul>
</div>




</div> <!-- .pageheader -->



<div id="content">
<h2>Installing FreeBSD 9-CURRENT XENHVM on XCP</h2>

<p>To install <a href="http://www.freebsd.org/">FreeBSD</a> on XCP:</p>

<ol>
<li>Download the <em>amd64</em> <a href="ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/201105/FreeBSD-9.0-CURRENT-201105-amd64-dvd1.iso">FreeBSD 9-CURRENT snapshot</a> ( <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/mirrors-ftp.html">mirrors</a> )</li>
<li><p>Put the .iso in an ISO SR. I cheated by putting it in /opt/xensource/packages/iso in dom0 and then, in dom0:</p>

<pre><code>SR=&#036;(xe sr-list name-label="XenServer Tools" params=uuid --minimal)
xe sr-scan uuid=&#036;SR
</code></pre></li>
<li><p>Install it as an HVM guest via the "Other install media" template:</p>

<pre><code>VM=&#036;(xe vm-install template-name-label="Other install media" new-name-label=freebsd)
xe vm-disk-add vm=freebsd disk-size=8GiB device=0
xe vm-cd-add vm=freebsd cd-name=FreeBSD-9.0-CURRENT-201105-amd64-dvd1.iso device=1
NET=&#036;(xe network-list bridge=xenbr0 params=uuid --minimal)
xe vif-create vm-uuid=&#036;VM network-uuid=&#036;NET device=0
xe vm-start vm=freebsd
</code></pre></li>
<li><p>Make sure you install the src/ package when you're asked</p></li>
<li><p>When it reboots back into the installer, it's time to get rid of the install CD:</p>

<pre><code>xe vm-shutdown vm=freebsd --force
xe vm-cd-eject vm=freebsd
xe vm-start vm=freebsd
</code></pre>

<p>We now have a pure HVM amd64 FreeBSD 9-CURRENT. Next step is to add the PV drivers. </p></li>
<li><p>Log into the VM as root and type:</p>

<pre><code>cd /usr/src
make buildkernel KERNCONF=XENHVM
make installkernel KERNCONF=XENHVM
</code></pre>

<p>Don't reboot yet! You need to adjust your boot options slightly.</p></li>
<li><p>Edit /etc/fstab and convert the substring "ada0" into "ad0"</p></li>
<li>Edit /etc/rc.conf and conver the substring "ifconfig_re0" into "ifconfig_xn0"</li>
</ol>

<p>Now reboot and enjoy!</p>

<h2>Notes</h2>

<ol>
<li><p>Make sure you use the amd64 version. The i386 version doesn't compile the xen stuff by default; if you make a custom kernel config and turn the xen stuff on you'll find that it locks up during boot.</p></li>
<li><p>The 'ada0' to 'ad0' conversion seems to be a mismatch between regular IDE device naming (where the scheme was recently changed) and the xen blkfront's attempt to look like a regular IDE device, to simplify usage. My guess is that the xen blkfront will be updated to use the new convention and this step will become unnecessary. There has always been a bit of confusion in the world of xen over whether adding a PV driver should be a transparent performance upgrade or should be exposed as a totally separate disk.</p></li>
</ol>

</div>


<div id="comments">




<div class="addcomment">Comments on this page are closed.</div>

</div>


<div id="footer" class="pagefooter">
<div id="pageinfo">









<div class="pagedate">
Last edited <span class="date">Sat 11 Jun 2011 13:28:17 BST</span>
<!-- Created <span class="date">Sat 11 Jun 2011 12:04:11 BST</span> -->
</div>

</div><!-- #pageinfo -->

<!-- from Dave Scott -->
</div><!-- .pagefooter #footer -->

</body>
</html>
