<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>2011-03-14-pvfb</title>

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css" type="text/css" />





</head>
<body>

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">

<a href="../../">Dave Scott</a>/ 

<a href="../">posts</a>/ 

</span>
<span class="title">
2011-03-14-pvfb

</span>
</span><!--.header-->

</div>


<div class="actions">
<ul>


<li><a href="../../recentchanges/">RecentChanges</a></li>





<li><a href="./#comments">Comments</a><br /></li>

</ul>
</div>




</div> <!-- .pageheader -->



<div id="content">
<h1>Xen Cloud Platform and PVFB</h1>

<p>While talking to Stefano and Jon Ludlam last week the question came up,
"why doesn't XCP use PVFB?"</p>

<p><a href="http://lwn.net/Articles/270771/">PVFB</a> is a pair of paravirtual 
frontend/backend drivers for framebuffer, keyboard and mouse which together
allow fully PV guests to have a modern graphical console. Currently PV
guests on XCP only expose a plain text console via a program called "vncterm".</p>

<p>It turns out that most of the code you need for PVFB is already there: it's 
just a matter of turning it on. I did a bit of hacking in 
<a href="https://github.com/djs55/xen-api/tree/pvfb">my pvfb branch on github</a>
and now you can request the use of PVFB by setting a VM.platform flag as 
follows:</p>

<pre><code>xe vm-param-set uuid=.... platform:pvfb=true
</code></pre>

<p>When I started my Debian squeeze guest, I was greeted with a nice PVFB text
console. </p>

<table>
<tr>
<td><img src="/blog/images/vncterm.png"></td>
<td><img src="/blog/images/pvfb.png"></td>
</tr>
<tr>
<td>Before: vncterm</td>
<td>After: PVFB</td>
</tr>
</table>

<p>OK, so perhaps that's not the most exciting change in the world. However in
the PVFB case I can now start X and gnome, which is when the fun really starts.</p>

<h2>Debian Squeeze and PVFB</h2>

<p>There are two problems with out-of-the-box X on squeeze with a PVFB:</p>

<ol>
<li>the keyboard doesn't work</li>
<li>the mouse doesn't work either</li>
</ol>

<p>Thankfully both can be fixed. To fix the keyboard we need to set a "XkbLayout"
to some sensible value, otherwise pressing keys does result in KeyPress and
KeyRelease events (as seen in "xev") but these have no associated X keysym.</p>

<pre><code>cat &lt;&lt;EOF &gt;/usr/share/X11/xorg.conf.d/16-xen-virtual-keyboard.conf
Section "InputClass"
        Identifier "xen"
        MatchProduct "Xen Virtual Keyboard"
        Driver "evdev"
        Option "XkbLayout" "us"
EndSection
EOF
</code></pre>

<p>To fix the mouse we have to explicitly tell X to expect only absolute positions
from the xen virtual pointer, ignoring the fact that -- in theory -- it may
send relative updates too:</p>

<pre><code>cat &lt;&lt;EOF &gt;/usr/share/X11/xorg.conf.d/15-xen-virtual-pointer.conf
Section "InputClass"
        Identifier "xen"
        MatchProduct "Xen Virtual Pointer"
        Driver "evdev"
        Option "IgnoreRelativeAxes" "True"
EndSection
EOF
</code></pre>

<p>With both of these tweaks we have a working graphical console!</p>

<p><img src="/blog/images/gnome-terminal-small.png" alt="Debian squeeze + XCP + PVFB" /></p>

<h2>The absolute vs relative co-ordinates mismatch</h2>

<p>There's a fascinating analysis on
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=523914">bug #523914 on RedHat's bugzilla</a> and then on <a href="http://xen.1045712.n5.nabble.com/RFC-drop-frontend-support-for-relative-pointer-td2539330.html">xen-devel</a>. It turns out that, almost
everyone in the universe with a PVFB is using absolute co-ordinates (with the
notable exception of XCI) since the protocol "prefers" absolute over relative,
and the implemention that supports absolute was written before the code was
merged into the official xen tree. However, because of the theoretical 
possibility that some system only supports relative, the frontend advertises
itself to "evdev" as being capable of both absolute and relative. 
Unfortunately for mice (not touchpads or touchscreens), "evdev" "prefers" 
relative over absolute so we end up in a situation where the backend sends
absolute events and evdev is expecting to receive relative ones. The result is 
an error in the X log:</p>

<pre><code>(II) Xen Virtual Pointer: initialized for relative axes.
(WW) Xen Virtual Pointer: ignoring absolute axes.
</code></pre>

<p>and a non-working pointer. The workaround I described above tells the X server
to ignore the relative axes and to really expect absolute co-ordinates.</p>

<h2>Conclusion</h2>

<ul>
<li>The PVFB code is present and works at least as well as "vncterm" for 
text-based stuff.</li>
<li>The X configuration needs to be slightly tweaked -- it doesn't just work
out of the box. This is still better than "vncterm" where X will never
work (unless you like ascii-art)</li>
<li>We should consider switching to PVFB by default, on a guest-per-guest
basis (after checking the kernels have new enough frontends)</li>
<li>We should develop a plan to fix the niggles with X, particularly the
relative vs absolute mouse. If necessary perhaps we need to supply the
guest with two pointers: one relative-only and one absolute-only?</li>
</ul>

</div>


<div id="comments">




<div class="addcomment">Comments on this page are closed.</div>

</div>


<div id="footer" class="pagefooter">
<div id="pageinfo">


<div class="tags">
Tags:

<a href="../../tags/XCP/" rel="tag">XCP</a>

</div>








<div class="pagedate">
Last edited <span class="date">Mon 14 Mar 2011 16:25:26 GMT</span>
<!-- Created <span class="date">Mon 14 Mar 2011 16:01:09 GMT</span> -->
</div>

</div><!-- #pageinfo -->

<!-- from Dave Scott -->
</div><!-- .pagefooter #footer -->

</body>
</html>
